# SystÃ¨me de ConformitÃ© - Documentation

## ğŸ“‹ Vue d'ensemble

Le systÃ¨me de conformitÃ© permet de gÃ©rer les dÃ©clarations et validations de conformitÃ© pour les entreprises. Il comprend :

- **Gestion des items** : Configuration des Ã©lÃ©ments Ã  dÃ©clarer
- **PÃ©riodes de validitÃ©** : DÃ©finition des pÃ©riodes actives pour chaque item
- **Soumissions** : Interface pour soumettre les dÃ©clarations
- **Validation** : Workflow d'approbation/rejet par les administrateurs
- **Historique** : TraÃ§abilitÃ© complÃ¨te de toutes les actions

## ğŸ—ï¸ Architecture

### Composants Livewire

1. **ComplianceBoard** (`App\Livewire\Settings\ComplianceBoard`)
   - Tableau de bord principal avec vue d'ensemble
   - Filtres avancÃ©s (catÃ©gorie, pÃ©riode, statut)
   - Statistiques en temps rÃ©el
   - AccÃ¨s rapide aux actions

2. **ItemsManager** (`App\Livewire\Settings\ItemsManager`)
   - Gestion CRUD des items
   - Support de 4 types : texte, documents, liste, checkbox
   - Configuration des options pour listes/checkbox

3. **PeriodesManager** (`App\Livewire\Settings\PeriodesManager`)
   - Gestion des pÃ©riodes de validitÃ©
   - Validation anti-chevauchement
   - Renouvellement automatique

4. **SubmitForm** (`App\Livewire\Settings\SubmitForm`)
   - Formulaire de soumission adaptÃ© au type d'item
   - Support de l'Ã©dition des soumissions en attente
   - Gestion des fichiers

5. **ReviewForm** (`App\Livewire\Settings\ReviewForm`)
   - Interface de validation pour administrateurs
   - Approbation/Rejet avec confirmation
   - Historique de validation

6. **HistoryModal** (`App\Livewire\Settings\HistoryModal`)
   - Historique complet des soumissions
   - Filtres et recherche
   - Statistiques par item

### ModÃ¨les

```
Item (items)
â”œâ”€â”€ categorieDommaine (BelongsTo)
â”œâ”€â”€ options (HasMany) - pour listes/checkbox
â”œâ”€â”€ periodes (HasMany)
â”œâ”€â”€ periodeActive (HasOne)
â”œâ”€â”€ submissions (HasMany)
â””â”€â”€ latestSubmission (HasOne)

PeriodeItem (periode_items)
â”œâ”€â”€ item (BelongsTo)
â”œâ”€â”€ entreprise (BelongsTo)
â””â”€â”€ submissions (HasMany)

ConformitySubmission (conformity_submissions)
â”œâ”€â”€ item (BelongsTo)
â”œâ”€â”€ periode (BelongsTo)
â”œâ”€â”€ entreprise (BelongsTo)
â”œâ”€â”€ submitter (BelongsTo User)
â”œâ”€â”€ reviewer (BelongsTo User)
â””â”€â”€ answers (HasMany)

ConformityAnswer (conformity_answers)
â””â”€â”€ submission (BelongsTo)
```

## ğŸš€ Installation

### 1. Migrations

```bash
php artisan migrate
```

Les tables crÃ©Ã©es :
- `items` - Items de conformitÃ©
- `item_options` - Options pour listes/checkbox
- `periode_items` - PÃ©riodes de validitÃ©
- `conformity_submissions` - Soumissions
- `conformity_answers` - RÃ©ponses aux soumissions
- `entreprise_items` - Pivot entreprise-items
- `entreprise_categorie_domaines` - Pivot entreprise-catÃ©gories
- `entreprise_domaines` - Pivot entreprise-domaines

### 2. DÃ©pendances Frontend

Dans votre `resources/js/app.js` :

```javascript
import './notifications';
```

Dans votre layout principal (`app.blade.php` ou Ã©quivalent) :

```blade
<!DOCTYPE html>
<html>
<head>
    <!-- ... -->
    @stack('styles')
</head>
<body>
    <!-- ... -->
    
    @stack('scripts')
</body>
</html>
```

### 3. Configuration Vite

Dans `vite.config.js` :

```javascript
export default defineConfig({
    plugins: [
        laravel({
            input: [
                'resources/css/app.css',
                'resources/js/app.js',
                'resources/js/notifications.js', // Ajouter cette ligne
            ],
            refresh: true,
        }),
    ],
});
```

### 4. Assets

Inclure dans vos vues :

```blade
<x-conformite-assets />
```

Ou manuellement :

```blade
@push('styles')
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
@endpush

@push('scripts')
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    @vite(['resources/js/notifications.js'])
@endpush
```

## ğŸ“± Utilisation

### Tableau de Bord

```blade
<livewire:settings.compliance-board />
```

Affiche :
- Statistiques globales (total, en attente, approuvÃ©s, rejetÃ©s)
- Filtres (recherche, catÃ©gorie, pÃ©riode, statut)
- Grille des items avec statut visuel
- Actions rapides (soumettre, historique)

### Configuration des Items

```blade
<!-- Bouton pour ouvrir la modale -->
<button data-bs-toggle="modal" data-bs-target="#addItemModal">
    GÃ©rer les Items
</button>

<!-- Modale -->
<livewire:settings.items-manager />
```

### Wizard de Configuration

```blade
<livewire:settings.enterprise-config-wizard />
```

Permet Ã  l'entreprise de sÃ©lectionner :
1. Ses domaines
2. Ses catÃ©gories (filtrÃ©es par domaines)
3. Ses items (filtrÃ©s par catÃ©gories)

## ğŸ¨ Personnalisation

### Notifications

Le systÃ¨me utilise SweetAlert2 pour les notifications. Vous pouvez les dÃ©clencher :

**Depuis PHP (Livewire) :**

```php
$this->dispatch('notify', [
    'type' => 'success', // success|error|warning|info
    'message' => 'OpÃ©ration rÃ©ussie !',
    'title' => 'Bravo !' // optionnel
]);
```

**Depuis JavaScript :**

```javascript
window.notify('success', 'OpÃ©ration rÃ©ussie !', 'Bravo !');
```

**Confirmation :**

```javascript
const result = await window.confirmAction(
    'Voulez-vous vraiment supprimer ?',
    'Confirmer la suppression'
);

if (result.isConfirmed) {
    // Action confirmÃ©e
}
```

### Styling

Toutes les vues utilisent Bootstrap 5 et Tabler Icons. Vous pouvez personnaliser :

1. **Couleurs** : Modifiez les classes Bootstrap (`.bg-primary`, `.text-success`, etc.)

2. **Animations** : Ajustez dans `conformite-assets.blade.php`

3. **Layout** : Les modales sont full-responsive et peuvent Ãªtre redimensionnÃ©es

### Types d'Items

4 types supportÃ©s :

1. **Texte** (`type: 'texte'`)
   - Champ textarea simple
   - StockÃ© dans `ConformityAnswer.value_text`

2. **Documents** (`type: 'documents'`)
   - Upload multiple de fichiers
   - Formats : pdf, jpg, jpeg, png, doc, docx
   - Taille max : 10MB par fichier
   - StockÃ© dans `public/conformity/docs/`

3. **Liste** (`type: 'liste'`)
   - Choix unique parmi des options
   - Options configurables avec label/value
   - StockÃ© en JSON dans `ConformityAnswer.value_json`

4. **Checkbox** (`type: 'checkbox'`)
   - Choix multiple parmi des options
   - Options configurables avec label/value
   - StockÃ© en JSON dans `ConformityAnswer.value_json`

## ğŸ”’ Permissions

### RÃ´les

Le systÃ¨me utilise la table `roles` existante avec l'attribut `SuperAdmin` :

- **SuperAdmin** (`SuperAdmin = 1`) : AccÃ¨s complet
- **ValideAudit** : Peut valider les soumissions
- **Entreprise** : Peut soumettre et voir ses soumissions

### VÃ©rification

```php
// Dans un composant Livewire
if (auth()->user()->role->SuperAdmin) {
    // Actions super admin
}

if (auth()->user()->role->nom === 'ValideAudit') {
    // Actions de validation
}
```

## ğŸ”„ Workflow

### 1. Configuration (Super Admin)

```
1. CrÃ©er des domaines
2. CrÃ©er des catÃ©gories par domaine
3. CrÃ©er des items par catÃ©gorie
4. Assigner domaines/catÃ©gories/items aux entreprises
5. DÃ©finir des pÃ©riodes de validitÃ©
```

### 2. Soumission (Entreprise)

```
1. AccÃ©der au tableau de bord
2. SÃ©lectionner un item avec pÃ©riode active
3. Remplir le formulaire selon le type
4. Soumettre (statut: 'soumis')
5. PossibilitÃ© d'Ã©diter tant que non validÃ©
```

### 3. Validation (Admin)

```
1. Voir les soumissions en attente
2. Consulter les dÃ©tails
3. Approuver (statut: 'approuvÃ©') ou Rejeter (statut: 'rejetÃ©')
4. Ajouter des commentaires (obligatoire pour rejet)
```

### 4. Correction (Entreprise)

```
Si rejetÃ©:
1. Consulter les commentaires
2. Resoumettre avec corrections
3. Retour Ã  l'Ã©tape de validation
```

## ğŸ“Š Ã‰tats et Statuts

### Statuts de Soumission

- `soumis` : En attente de validation
- `approuvÃ©` : ValidÃ© par un administrateur
- `rejetÃ©` : RefusÃ©, nÃ©cessite correction

### Statuts de PÃ©riode

- `1` : Active
- `0` : Inactive/AnnulÃ©e

### MÃ©thodes Utiles

```php
// Sur ConformitySubmission
$submission->isFinal(); // true si approuvÃ© ou rejetÃ©
$submission->isPending(); // true si soumis

// Sur PeriodeItem
$periode->isActive(); // true si pÃ©riode en cours
$periode->isExpired(); // true si pÃ©riode dÃ©passÃ©e
```

## ğŸ› DÃ©pannage

### Les modales ne s'ouvrent pas

VÃ©rifiez que Bootstrap JS est chargÃ© :

```blade
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
```

### Les notifications ne s'affichent pas

1. VÃ©rifier que SweetAlert2 est chargÃ©
2. VÃ©rifier la console pour les erreurs JS
3. Tester manuellement : `window.notify('success', 'Test')`

### Erreurs de validation

Les erreurs sont affichÃ©es automatiquement sous les champs. VÃ©rifiez les rÃ¨gles dans les composants Livewire.

### ProblÃ¨mes de chevauchement de pÃ©riodes

Le systÃ¨me vÃ©rifie automatiquement. Si le message persiste, vÃ©rifiez la base de donnÃ©es pour des pÃ©riodes actives existantes.

## ğŸ“ Exemples

### Exemple Complet d'Utilisation

```blade
{{-- Dans votre layout ou page --}}
@extends('layouts.app')

@section('content')
    {{-- Inclure les assets --}}
    <x-conformite-assets />

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Gestion de la ConformitÃ©</h2>
            </div>
        </div>

        {{-- Tableau de bord principal --}}
        <livewire:settings.compliance-board />

        {{-- Boutons de gestion (pour Super Admin) --}}
        @if(auth()->user()->role->SuperAdmin)
            <div class="mt-4">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <i class="ti ti-settings me-2"></i>GÃ©rer les Items
                </button>
            </div>

            {{-- Modale de gestion des items --}}
            @include('livewire.settings.items-manager')
        @endif
    </div>
@endsection
```

## ğŸ”— Ressources

- [Livewire Documentation](https://laravel-livewire.com/docs)
- [Bootstrap 5](https://getbootstrap.com/)
- [SweetAlert2](https://sweetalert2.github.io/)
- [Tabler Icons](https://tabler-icons.io/)

## ğŸ“ Support

Pour toute question ou problÃ¨me :
1. Consultez les logs Laravel : `storage/logs/laravel.log`
2. VÃ©rifiez la console JavaScript (F12)
3. Testez avec les donnÃ©es d'exemple